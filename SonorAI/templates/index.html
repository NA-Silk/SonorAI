{% load static %}
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SonorAI - Home</title>
    <link rel="stylesheet" href="{% static 'styles.css' %}">
</head>

<script src="{% static 'script.js' %}"></script>
<script src="https://www.verovio.org/javascript/latest/verovio-toolkit.js"></script>
<script>
    document.addEventListener("DOMContentLoaded", () => {
        const xml = document.getElementById("xmlText");
        const notationDiv = document.getElementById("notation");

        if (xml && notationDiv) {
            try {
                const vrvToolkit = new verovio.toolkit();

                vrvToolkit.setOptions({
                    scale: 35,                 // baseline size
                    pageWidth: 5000,           // large virtual page
                    pageHeight: 2000,
                    adjustPageHeight: true,
                    breaks: "auto",            // allow normal line breaks
                    ignoreLayout: 1
                });

                const xmlText = (xml.textContent || "").trim();
                if (!xmlText) return;

                vrvToolkit.loadData(xmlText);
                const svg = vrvToolkit.renderToSVG(1, {});
                notationDiv.innerHTML = svg;

                const svgEl = notationDiv.querySelector("svg");
                if (svgEl) {
                    svgEl.removeAttribute("width");
                    svgEl.removeAttribute("height");
                    svgEl.setAttribute("preserveAspectRatio", "xMidYMid meet");
                    svgEl.style.width = "100%";
                    svgEl.style.height = "auto";
                    svgEl.style.maxWidth = "100%";
                }

            } catch (e) {
                notationDiv.innerHTML = "<p style='color:red'>Unable to render MusicXML.</p>";
                console.error(e);
            }
        }
    });
</script>

<body>
    <!-- Navigation bar -->
    <div id="app">
        <div class="page active">
            <div class="page-container">

                <!-- Header -->
                <header class="header">
                    <div class="logo-box">
                        <a href="/" class="logo-text">SonorAI</a>
                    </div>

                    <nav class="nav-buttons">
                        <a href="{% url 'homepage' %}" class="nav-btn">Home</a>
                        {% if user.is_authenticated %}
                        <a href="{% url 'myfiles' %}" class="nav-btn">My Files</a>
                        <a href="{% url 'logout' %}" class="nav-btn">Logout</a>
                        {% else %}
                        <a href="{% url 'register' %}" class="nav-btn">Register</a>
                        <a href="{% url 'login' %}" class="nav-btn">Login</a>
                        {% endif %}
                    </nav>
                </header>

                <!-- Main Content -->
                <div class="main-content">
                    <div class="content-card">

                        <!-- Header -->
                        <div class="card-header">
                            <div class="logo-image">
                                <img src="{% static 'SonorAI_logo.png' %}" alt="SonorAI Logo">
                            </div>
                            <p class="title">Generate Music Tab</p>
                        </div>

                        <!-- Upload Section -->
                        <div class="card-buttons">
                            <form action="{% url 'upload_audio' %}" method="post"
                                enctype="multipart/form-data" class="upload-form">
                                {% csrf_token %}
                                
                                <label class="upload-btn">
                                    <input type="file" id="audio_file" name="audio_file" accept=".wav" required>
                                    <span>Upload Audio File</span>
                                </label>
                                
                                <button type="submit" class="upload-btn">
                                    <span>Submit</span>
                                </button>
                            </form>
                        </div>

                        <!-- Output Section -->
                        {% if musicxml %}
                        <div class="xml-card-container">
                            <div class="xml-card">
                                <h4 class="xml-card-title" style="margin-top:10px">MusicXML Preview</h4>

                                {% if pk %}
                                <a href="{% url 'download_musicxml' pk %}" class="xml-download-btn">Download MusicXML</a>
                                {% endif %}

                                <pre id="xmlText" class="xml-preview">{{ musicxml }}</pre>
                                <h4 class="xml-card-title" style="margin-top:10px">Music Notation Preview</h4>
                                <div id="notation" class="notation-preview"></div>
                            </div>
                        </div>
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>
    </div>
</body>
</html>
