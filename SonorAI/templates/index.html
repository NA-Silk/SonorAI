<!DOCTYPE html>
<html lang="en">
<head>
    {% load static %}
    <title>Home Page</title>
    <meta charset="UTF-8">
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css">

<script src="https://www.verovio.org/javascript/latest/verovio-toolkit.js"></script>
<script>
    document.addEventListener("DOMContentLoaded", () => {
        const xml = document.getElementById("xmlText");
        const notationDiv = document.getElementById("notation");

        if (xml && notationDiv) {
            try {
                const vrvToolkit = new verovio.toolkit();
                vrvToolkit.setOptions({scale: 50})
                vrvToolkit.loadData(xml.textContent);
                const svg = vrvToolkit.renderToSVG(1, {});
                notationDiv.innerHTML = svg;
            } catch (e) {
                notationDiv.innerHTML = "<p class='text-danger'>Unable to render MusicXML.</p>";
                console.error(e);
            }
        }
    });
</script>
</head>
<body>

<!-- Navigation bar -->
<nav class="navbar navbar-light bg-light">
    <div class="container-fluid">
        <div class="navbar-header">
            <a class="navbar-brand" href="/">SonorAI</a>
        </div>

        <ul class="nav navbar-nav navbar-right">
            {% if user.is_authenticated %}
            <li>
                <a class="btn btn-link" href="#">{{ user.first_name }}({{ user.username }})</a>
                <a class="btn btn-link" href="/myfiles/">My Files</a>
                <a class="btn btn-link" href="{% url 'logout' %}">Logout</a>
            </li>
            {% else %}
            <li>
                <form class="form-inline" action="{% url 'login' %}" method="post">
                    {% csrf_token %}
                    <div class="input-group">
                        <input type="text" class="form-control" placeholder="Username" name="username" >
                        <input type="password" class="form-control" placeholder="Password" name="psw" >
                        <button class="btn btn-primary" type="submit">Login</button>
                        <a class="btn btn-link" href="{% url 'register' %}">Sign Up</a>
                    </div>
                </form>
            </li>
            {% endif %}
        </ul>

    </div>
</nav>

<!--Upload Section-->
<h3>Upload Audio File (*.wav)</h3>
<form action="{% url 'upload_audio' %}" method="post" enctype="multipart/form-data" class="mt-3">
    {% csrf_token %}
    <div class="form-group">
        <label for="audio_file">Choose WAV file:</label>
        <input type="file" class="form-control-file" id="audio_file" name="audio_file" accept=".wav" required>
    </div>
    <button type="submit" class="btn btn-primary mt-2">Upload</button>
</form>
{% if message %}
<p class="alert alert-info mt-3">{{ message }}</p>
{% endif %}

<!--Output Section-->
{% if musicxml %}
<div class="mt-4 p-3 border rounded bg-light">
    <h4>MusicXML Output</h4>
    <!--Download button for signed in users-->
    {% if pk %}
        <a class="btn btn-success mb-3" 
           href="{% url 'download_musicxml' pk %}">
            Download MusicXML
        </a>
    {% endif %}
    <!--MusicXML Output-->
    <pre id="xmlText" style="white-space: pre-wrap; max-height:200px; overflow:auto;">{{ musicxml }}</pre>
    <h4 class="mt-4">Music Notation Preview</h4>
    <div id="notation" class="border p-3"></div>
</div>
{% endif %}

</body>
</html>
